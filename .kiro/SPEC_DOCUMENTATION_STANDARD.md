# Spec 文档规范标准

> **版本**: v1.0.0  
> **创建日期**: 2026-01-16  
> **状态**: 🔴 必读规范  
> **适用范围**: 所有新功能和重大重构

---

## 一、规范概述

### 1.1 三层文档结构

所有新功能和重大重构必须使用三层文档结构：

```
.kiro/specs/{feature-name}/
├── requirements.md    # 需求文档（WHAT - 要做什么）
├── design.md          # 设计文档（HOW - 怎么做）
└── tasks.md           # 任务文档（WHO/WHEN - 谁来做、何时做）
```

### 1.2 文档职责

| 文档 | 职责 | 目标读者 | 内容重点 |
|------|------|---------|---------|
| **requirements.md** | 定义功能需求 | 产品、业务、测试 | User Story、Acceptance Criteria |
| **design.md** | 技术架构设计 | 架构师、技术负责人 | 架构决策、数据模型、API接口 |
| **tasks.md** | 实施任务清单 | 开发人员 | 文件路径、代码规范、验收标准 |

### 1.3 文档关系

```
Requirements (需求) 
    ↓ 驱动
Design (设计)
    ↓ 指导
Tasks (任务)
    ↓ 实施
Code (代码)
```

### 1.4 任务执行原则

- **凡设计即交付**：纳入 requirements / design / tasks 的每一项，均须**专业、认真完成**，不区分「可选」与「必选」。
- **任务即承诺**：写入 tasks.md 的任务视为承诺交付；若某条暂不实施，应从清单中移除或单独标注为「暂缓」并说明原因，不得以「可选」为由半成品收口。
- **同一标准**：同一 spec 内所有任务采用相同验收标准与完成度要求。

### 1.5 Spec 密度与验收原则（借鉴 DoD / 可执行验收）

- **Spec 驱动实现与验收**：Spec 应足够完整与精确，使**实现与验收均可由 spec 驱动**；验收标准宜可被自动化或脚本执行（如 verify 的 grep/cli/api/script），不依赖对代码的语义级人工解读。
- **验收可执行**：功能清单中每一项的「验收方式」尽量**可执行**（CLI 命令、API 调用、verify 的一条 check 或 runnable scenario）；新 spec 的验收条件尽量对应到 verify 的一条 check 或可运行脚本。
- **Definition of Done (DoD)**：P0 或关键 spec 的 requirements 或 design 中宜包含 **Definition of Done** 专节，形式为分组 `- [ ]` 清单（每项对应可验证行为），可选末尾「验收矩阵」（场景 × 维度，每格须通过）；收口 = 本节每项打勾 + 实现+测试通过。
- **验证优先自动化**：在满足收口质量的前提下，优先用 CI/本地脚本跑验证，减少依赖长对话中 Agent 反复跑验证的轮次。
- **收口以自动化验收为准**：收口 = 可执行验收通过；人工 code review 不作为收口前提，可作为合规或安全策略的附加要求。

---

## 二、Requirements.md 规范

### 2.1 文档结构

```markdown
# Requirements: [功能名称]

> **目标**：[一句话描述目标]  
> **优先级**：P0/P1/P2  
> **预估工作量**：X-Y 天

---

## 1. 背景与动机

### 1.1 当前问题
[描述现状问题]

### 1.2 设计目标
[描述设计目标]

---

## 2. 用户故事

### 2.1 作为 [角色]

**故事 1**：[标题]
```
作为 [角色]
我希望 [目标]
这样我可以 [价值]
```

**验收标准**：
- [ ] 验收标准1
- [ ] 验收标准2

---

## 3. 功能需求

### 3.1 [需求分类]

#### FR-1：[需求标题]

**需求**：[需求描述]

**接口定义**（如适用）：
```typescript
// 接口示例
```

**验收标准**：
- [ ] 验收标准1
- [ ] 验收标准2

---

## 4. 非功能需求

### 4.1 [分类]

**NFR-1：[需求标题]**
- [需求描述]

**验收标准**：
- [ ] 验收标准1

---

## 5. 验收标准总览

### 5.1 功能验收
- [ ] **FR-1**：[简述]
- [ ] **FR-2**：[简述]

### 5.2 非功能验收
- [ ] **NFR-1**：[简述]

### 5.3 测试验收
- [ ] 单元测试覆盖率 > 80%
- [ ] 集成测试覆盖核心场景

---

## 6. 约束与假设

### 6.1 约束
- [约束1]

### 6.2 假设
- [假设1]

---

## 7. 依赖

### 7.1 外部依赖
- [依赖1]

### 7.2 内部依赖
- [依赖1]

---

## 8. 风险与缓解

### 8.1 风险：[风险描述]

**影响**：[影响描述]

**缓解**：
- [缓解措施1]

---

## 9. Definition of Done（DoD，P0/关键 spec 建议包含）

> 本节定义「实现何时算完成」：**每项打勾且对应验收通过**即该项 done；全节打勾 + 实现+测试通过 = spec 收口。

### 9.1 [领域分组 1]
- [ ] 可验证项 1（对应验收方式或 verify check）
- [ ] 可验证项 2

### 9.2 [领域分组 2]
- [ ] 可验证项 1

### 9.3 验收矩阵（可选）
| 场景/维度 | 检查项 | 通过 |
|-----------|--------|------|
| [行] | [列] | [ ] |

---

## 10. 参考文档

- [文档1](链接)

---

**维护者**：[团队名称]  
**最后更新**：YYYY-MM-DD
```

### 2.2 格式要求

#### 2.2.1 文档头部

```markdown
> **目标**：[一句话描述]  
> **优先级**：P0/P1/P2  
> **预估工作量**：X-Y 天
```

#### 2.2.2 用户故事格式

```markdown
**故事 N**：[标题]
```
作为 [角色]
我希望 [目标]
这样我可以 [价值]
```

**验收标准**：
- [ ] 验收标准1
- [ ] 验收标准2
```

#### 2.2.3 功能需求编号

使用 FR-N（Functional Requirement）格式：

```markdown
#### FR-1：[需求标题]

**需求**：[需求描述]

**验收标准**：
- [ ] 验收标准1
```

#### 2.2.4 非功能需求编号

使用 NFR-N（Non-Functional Requirement）格式：

```markdown
**NFR-1：[需求标题]**
- [需求描述]

**验收标准**：
- [ ] 验收标准1
```

### 2.3 内容要求

- ✅ 必须包含文档头部（目标、优先级、预估工作量）
- ✅ 必须包含背景与动机
- ✅ 每个需求必须有用户故事
- ✅ 每个需求必须有验收标准
- ✅ 必须包含功能需求（FR-N）和非功能需求（NFR-N）
- ✅ 必须包含验收标准总览
- ✅ 必须包含约束与假设
- ✅ 必须包含依赖关系
- ✅ 必须包含风险与缓解
- ✅ **P0 或关键 spec 建议**包含 Definition of Done 专节（§2.1 第 9 节），形式为分组清单 + 可选验收矩阵；每项与验收方式或 verify check 对应。
- ❌ 禁止包含技术实现细节
- ❌ 禁止包含文件路径、代码示例

---

## 三、Design.md 规范

### 3.1 文档结构

```markdown
# Design: [功能名称]

> **目标**：[一句话描述]  
> **状态**：设计中/已完成  
> **最后更新**：YYYY-MM-DD

---

## 1. 架构设计

### 1.1 整体架构

```
[ASCII 架构图]
```

### 1.2 核心组件

#### 组件 1：[组件名称]

**职责**：[组件职责]

**接口定义**：
```typescript
// 接口代码
```

---

## 2. 实现细节

### 2.1 文件结构

```
path/to/
├── file1.ts
└── file2.ts
```

### 2.2 [组件] 实现

**当前问题**：[问题描述]

**解决方案**：[方案描述]

**实现**：
```typescript
// 代码示例
```

**关键点**：
- [关键点1]

---

## 3. 数据流

### 3.1 [场景] 调用流程

```
[ASCII 流程图]
```

**关键点**：
- [关键点1]

---

## 4. 错误处理

### 4.1 [错误场景]

**场景**：[场景描述]

**处理**：
```typescript
// 错误处理代码
```

---

## 5. 配置

### 5.1 配置文件

```yaml
# 配置示例
```

### 5.2 环境变量

| 变量 | 说明 | 默认值 |
|------|------|--------|
| `VAR` | 说明 | 值 |

---

## 6. 测试策略

### 6.1 单元测试

```typescript
// 测试示例
```

### 6.2 集成测试

```typescript
// 测试示例
```

---

## 7. 迁移计划

### 7.1 Phase 1：[阶段名称]（X 天）

- [ ] 任务1
- [ ] 任务2

---

## 8. 风险与缓解

### 8.1 风险：[风险描述]

**影响**：[影响描述]

**缓解**：
- [缓解措施1]

---

## 9. 契约与 Mock（依赖外部服务/Platform 时必写）

### 9.1 API 契约
- 依赖的 API 路径、请求/响应 schema（或引用契约文档）
- 错误码与语义

### 9.2 Mock 策略
- 无真实服务时如何跑通验收（mock/stub 约定、环境变量或开关）
- 每个依赖外部的 spec 应有 mock 或契约说明，以便 Spec 循环与 CI 多数轮次不启真实依赖

---

## 10. 参考文档

- [文档1](链接)

---

**维护者**：[团队名称]  
**最后更新**：YYYY-MM-DD
```

### 3.2 格式要求

#### 3.2.1 架构图

使用 ASCII 艺术图（简洁清晰）：

```markdown
```
┌─────────────────┐
│   Component A   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   Component B   │
└─────────────────┘
```
```

#### 3.2.2 代码示例

```markdown
```typescript
// 实现示例
export class Service {
  async method(): Promise<void> {
    // ...
  }
}
```
```

#### 3.2.3 关键点说明

使用列表格式：

```markdown
**关键点**：
- 关键点1
- 关键点2
```

### 3.3 内容要求

- ✅ 必须包含文档头部（目标、状态、更新日期）
- ✅ 必须包含整体架构图（ASCII）
- ✅ 必须包含核心组件设计
- ✅ 必须包含实现细节（文件结构、代码示例）
- ✅ 必须包含数据流说明
- ✅ 必须包含错误处理
- ✅ 必须包含配置说明
- ✅ 必须包含测试策略
- ✅ 必须包含迁移计划（Phase 划分）
- ✅ 必须包含风险评估
- ✅ **依赖 Platform/外部服务时**须包含「契约与 Mock」节（§3.1 第 9 节）
- ❌ 禁止包含具体的任务清单（tasks.md 的职责）
- ❌ 禁止包含需求描述（requirements.md 的职责）

---

## 四、Tasks.md 规范

### 4.1 文档结构

```markdown
# Tasks: [功能名称]

> **状态**：未开始/进行中/已完成  
> **预估工作量**：X-Y 天  
> **最后更新**：YYYY-MM-DD  
> **执行原则**：本清单内所有任务均须专业、认真完成，不区分可选与必选（见规范 §1.4、§4.5）。

---

## 进度概览

- **总任务数**：N
- **已完成**：N
- **进行中**：N
- **未开始**：N

---

## 1. [阶段名称]（X 天）

### 1.1 [任务名称]
- [ ] 1.1.1 子任务1
- [ ] 1.1.2 子任务2
  - [ ] 1.1.2.1 细节任务1
  - [ ] 1.1.2.2 细节任务2

### 1.2 [任务名称]
- [ ] 1.2.1 子任务1

---

## 2. [阶段名称]（X 天）

### 2.1 [任务名称]
- [ ] 2.1.1 子任务1

---

## N. 验收清单

### N.1 功能验收
- [ ] 功能1
- [ ] 功能2

### N.2 性能验收
- [ ] 性能指标1

### N.3 测试验收
- [ ] 测试覆盖率 > 80%

### N.4 文档验收
- [ ] 文档完整

---

## N+1. 依赖与阻塞

### N+1.1 依赖
- 依赖1

### N+1.2 阻塞
- 无

---

## N+2. 风险

### N+2.1 风险描述
- **缓解**：缓解措施

---

## N+3. 参考文档

- [文档1](链接)

---

**维护者**：[团队名称]  
**最后更新**：YYYY-MM-DD
```

### 4.2 格式要求

#### 4.2.1 任务编号

使用层级编号格式：

```
1. 阶段名称
  1.1 任务名称
    1.1.1 子任务
      1.1.1.1 细节任务
```

#### 4.2.2 复选框格式

所有任务使用复选框：

```markdown
- [ ] 任务1
- [ ] 任务2
  - [ ] 子任务2.1
  - [ ] 子任务2.2
```

#### 4.2.3 进度跟踪

在文档头部包含进度概览：

```markdown
## 进度概览

- **总任务数**：35
- **已完成**：10
- **进行中**：5
- **未开始**：20
```

### 4.3 内容要求

- ✅ 必须包含文档头部（状态、预估工作量、更新日期）
- ✅ 必须包含进度概览
- ✅ 必须按阶段（Phase）组织任务
- ✅ 必须使用层级编号（1.1.1）
- ✅ 所有任务使用复选框格式
- ✅ 必须包含验收清单
- ✅ 必须包含依赖与阻塞
- ✅ 必须包含风险说明
- ❌ 禁止包含需求描述（requirements.md 的职责）
- ❌ 禁止包含架构设计（design.md 的职责）

### 4.4 集成点与跨 repo 依赖（必写）

- ✅ **集成点**：若任务涉及「组件 A 在何时、何处调用组件 B」，必须在 design 或 tasks 中**显式写出**（例如：run 开始时调用 shouldCompact；run 完成前调用 writeMemoryAndEmit）。禁止仅定义组件能力而不写调用时机。
- ✅ **跨 repo 依赖**：若本 spec 依赖其他仓库（如 Platform）提供的能力，必须在 requirements/design 中**显式列出**，并引用对方 spec（如「依赖 platform-ai-chat-tools」）。对方仓库须有对应 spec，否则本 spec 收口时该项标为「待依赖」。
- ✅ **收口前 E2E 验证**：功能清单打勾前必须**执行端到端验收**（或文档化验收步骤并执行通过），禁止仅因「代码存在」而打勾。
- ✅ **稳定通过**：核心路径建议在 CI 或本地**连续 2 次**通过后再打勾，避免一次通过就收口的脆弱性。
- ✅ **收口以自动化验收为准**：收口 = 可执行验收通过；人工 code review 不作为收口前提，可作为合规或安全附加要求。
- ✅ **表面实现标注**：若某能力仅有接口/调用点但链路未通（如无 handler 注册、依赖未实现），须在功能清单或 IMPLEMENTATION_AUDIT 中标注为「框架实现」或「待验证」，不得标为已收口。

### 4.5 任务完成标准（无可选/必选区分）

- 凡列入 tasks.md 的任务，均须按**同一标准**专业、认真完成，不设「可选任务」。
- 不得在任务列表中标注某条为「可选」「P2 可延后」等以降低完成度预期；若需延后，应移出清单或单独列为「暂缓」并写明原因。
- 验收清单中的每一项均须通过后再收口，禁止因「可选」而跳过验收。

---

## 五、文档创建流程

### 5.1 创建步骤

```
0. 阅读本规范第二、三、四章
   - 按 §2.1 的 requirements 结构模板编写，不得自创章节顺序或省略必选章节
   - 按 §3.1 的 design 结构模板编写（含架构图、实现细节、数据流、错误处理、配置、测试策略、迁移计划）
   - 按 §4.1 的 tasks 结构模板编写（含进度概览、按阶段组织、验收清单、依赖与阻塞、风险）

1. 创建目录
   mkdir -p .kiro/specs/{feature-name}

2. 创建 requirements.md
   - 定义功能需求
   - 编写 User Story
   - 编写 Acceptance Criteria

3. 创建 design.md
   - 技术架构设计
   - 数据模型设计
   - API 接口设计

4. 创建 tasks.md
   - 按 Phase 组织任务
   - 定义依赖关系
   - 编写验收标准

5. 评审和确认
   - 需求评审
   - 设计评审
   - 任务评审
```

### 5.2 参考示例

参考已有的优秀 spec 示例：

```bash
# 按模板创建
mkdir -p .kiro/specs/{feature-name}
# 然后按第二、三、四章模板编写 requirements.md / design.md / tasks.md
```

---

## 六、文档维护规范

### 6.1 更新原则

| 文档类型 | 何时更新 | 谁负责 |
|---------|---------|--------|
| **requirements.md** | 需求变更时 | 产品/业务 |
| **design.md** | 设计调整时 | 架构师/技术负责人 |
| **tasks.md** | 实施计划调整时 | 开发负责人 |

### 6.2 版本管理

- 使用 Git 管理文档版本
- 重大变更时更新文档版本号
- 在文档头部记录更新历史

### 6.3 文档状态

| 状态 | 说明 | 标识 |
|------|------|------|
| 🟢 设计完成 | 文档已完成，可以开始实施 | ✅ |
| 🟡 设计中 | 文档正在编写中 | ⏳ |
| 🔴 待设计 | 文档尚未开始 | ❌ |

### 6.4 已实现锁定（IMPLEMENTATION_LOCK.md）

- 若 spec 目录下存在 **`IMPLEMENTATION_LOCK.md`**，其中列出的任务与文件为**已实现且禁止 AI 覆盖**。
- **Kiro 或其它 AI 按本 spec 的 tasks.md 执行时**：须先读取该 spec 下的 `IMPLEMENTATION_LOCK.md`（如有）；对其中列为「已实现，禁止覆盖」的任务，**执行时跳过**，**不得**以重新实现、修复、对齐 spec 等为由**删除、还原或覆盖**其实现。
- 解除或修改锁定须经人工评审，并先更新 `IMPLEMENTATION_LOCK.md` 再改代码。

---

## 七、质量检查清单

### 7.1 Requirements.md 检查

- [ ] 包含文档头部（目标、优先级、预估工作量）
- [ ] 包含背景与动机
- [ ] 每个需求有用户故事
- [ ] 每个需求有验收标准
- [ ] 包含功能需求（FR-N）和非功能需求（NFR-N）
- [ ] 包含验收标准总览
- [ ] 包含约束与假设
- [ ] 包含依赖关系
- [ ] 包含风险与缓解
- [ ] 无技术实现细节

### 7.2 Design.md 检查

- [ ] 包含文档头部（目标、状态、更新日期）
- [ ] 包含整体架构图（ASCII）
- [ ] 包含核心组件设计
- [ ] 包含实现细节（文件结构、代码示例）
- [ ] 包含数据流说明
- [ ] 包含错误处理
- [ ] 包含配置说明
- [ ] 包含测试策略
- [ ] 包含迁移计划（Phase 划分）
- [ ] 包含风险评估
- [ ] 无任务清单

### 7.3 Tasks.md 检查

- [ ] 包含文档头部（状态、预估工作量、更新日期）
- [ ] 包含进度概览
- [ ] 按阶段（Phase）组织
- [ ] 使用层级编号（1.1.1）
- [ ] 所有任务使用复选框
- [ ] 包含验收清单
- [ ] 包含依赖与阻塞
- [ ] 包含风险说明
- [ ] 无需求描述和架构设计
- [ ] **集成点**：涉及调用的任务显式写出「何时、何处调用」（§4.4）
- [ ] **跨 repo 依赖**：若有，显式列出并引用对方 spec

---

## 八、参考示例

### 8.1 创建新 Spec

按照本规范第二、三、四章的模板结构，创建新的 spec 目录和三个文档文件。

---

## 九、规范执行

### 9.1 适用范围

- ✅ 所有新功能开发
- ✅ 所有重大重构
- ✅ 所有架构调整
- 小修复与 Bug 修复：若不纳入任何 spec，可不创建文档；**一旦纳入 spec（含 tasks.md），则须按本规范完整完成，不区分可选与必选**。

### 9.2 执行要求

- **凡创建 spec 即承诺交付**：新功能与重大重构须使用三层文档结构；tasks.md 中列出的**所有任务**均须专业、认真完成，不设「可选」「必选」之分。
- 小功能可采用简化版（至少 requirements.md + tasks.md），但**任务清单中的每一项同样须完整完成**。

### 9.3 评审流程

1. **需求评审**：Review requirements.md
2. **设计评审**：Review design.md
3. **任务评审**：Review tasks.md
4. **实施开始**：所有文档评审通过后开始实施

---

## 十、常见问题

### Q1: 小功能也需要三层文档吗？任务可以标「可选」吗？

**A**: 小功能可以使用简化版本，但至少需要 requirements.md 和 tasks.md。**一旦写入 tasks.md，该 spec 内所有任务均须专业、认真完成，不区分可选与必选**；若某条暂不做，应从清单移除或标为「暂缓」并说明原因。

### Q2: 文档需要多详细？

**A**: 原则是"足够详细，能够指导实施"。如果开发人员能够根据文档独立完成开发，说明文档足够详细。

### Q3: 文档可以合并吗？

**A**: 不建议。三层分离的目的是关注点分离，合并会降低可维护性。

### Q4: 如何快速创建文档？

**A**: 按照本规范第二、三、四章的模板结构创建目录和文件。

---

**规范版本**: v1.0.0  
**创建日期**: 2026-01-16  
**维护者**: 开发团队  
**审核状态**: ✅ 已审核
