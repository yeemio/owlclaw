# Requirements: Gateway Runtime Ops

> **目标**：建立网关发布运行标准（灰度、回滚、SLO、Runbook），使 API/MCP 发布可控。  
> **优先级**：P0  
> **预估工作量**：4-6 天

---

## 1. 背景与动机

- 当前发布流程偏“工程习惯”，缺少协议层专属门控和统一回滚准则。
- 无统一 SLO 与错误预算，难以量化“能否扩量”。

---

## 2. 用户故事

- 作为 SRE，我希望发布有 canary/扩量/全量门控。  
- 作为 oncall，我希望有标准 runbook 快速回滚。  
- 作为负责人，我希望发布证据可审计。

---

## 3. 功能需求

### FR-1 灰度发布策略
- [ ] 定义阶段比例、观察窗口、晋级条件
- [ ] 定义自动与人工晋级边界

### FR-2 自动回滚策略
- [ ] 定义触发指标与阈值
- [ ] 定义回滚后验证步骤

### FR-3 运维手册
- [ ] 覆盖启动、探针、故障分级、回滚、恢复

### FR-4 观测与SLO
- [ ] 定义协议层 SLO 与错误预算
- [ ] 对接监控仪表盘与告警规则

---

## 4. 非功能需求

- **NFR-1 可恢复性**：回滚路径可在 15 分钟内执行。
- **NFR-2 可观测性**：发布阶段指标可实时查看。
- **NFR-3 可审计性**：每次发布保留阶段化证据。

---

## 5. DoD

- [ ] 发布策略、回滚策略、SLO 文档齐全
- [ ] 一次 canary 失败自动回滚演练通过
- [ ] 一次全量发布演练通过

---

## 6. 量化阈值与验收矩阵

### 6.1 量化阈值

- canary 观测窗口：`>= 10 分钟`。
- 自动回滚阈值：错误率 `> 2%` 或 P95 时延上升 `> 40%`（相对基线）。
- 回滚完成时限：`<= 15 分钟`。

### 6.2 验收矩阵

| 场景 | 检查项 | 证据 | 通过 |
|------|--------|------|------|
| canary 发布 | SLO 门禁决策正确 | 发布日志 | [ ] |
| canary 失败 | 自动回滚触发 | 回滚日志 | [ ] |
| 全量发布 | 指标稳定 | 仪表盘快照 | [ ] |
| 人工回滚 | runbook 可执行 | 演练记录 | [ ] |

---

**维护者**：平台运维组  
**最后更新**：2026-02-26
