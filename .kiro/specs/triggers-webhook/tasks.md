# 实施计划：Webhook 触发器系统

## 文档联动

- requirements: `.kiro/specs/triggers-webhook/requirements.md`
- design: `.kiro/specs/triggers-webhook/design.md`
- tasks: `.kiro/specs/triggers-webhook/tasks.md`
- status source: `.kiro/specs/SPEC_TASKS_SCAN.md`


## 概述

本实施计划将 Webhook 触发器系统的设计转换为可执行的开发任务。系统采用 Python 实现，使用分层架构，包括 HTTP 接入层、验证层、转换层、执行层和持久化层。实施将按照从核心功能到高级特性的顺序进行，每个阶段都包含相应的测试任务。

## 任务

- [x] 0. **[Protocol-first]** 协议契约先行（决策 4.11）
  - [x] 0.1 定义 Webhook 端点注册的 JSON Schema（endpoint_config schema、payload schema、错误码表）
  - [x] 0.2 确认协议层不泄漏 Python 特有语义（无 Callable/装饰器元数据）
  - _说明：Task 1 的 Python 类型定义必须从本 schema 派生，不得反向定义协议_

- [x] 1. 设置项目结构和核心类型定义
  - 创建项目目录结构（`owlclaw/triggers/webhook/`, `owlclaw/triggers/webhook/http/`, `owlclaw/triggers/webhook/persistence/`）
  - 定义核心 Python 类型和模型（WebhookEndpoint, EndpointConfig, ValidationResult, ParsedPayload, AgentInput, ExecutionResult 等）
  - 配置静态检查与格式规范（ruff / mypy）
  - 设置测试框架（pytest）和属性测试库（hypothesis）
  - 复用项目数据库基础设施（PostgreSQL + SQLAlchemy + Alembic）
  - _需求：所有需求的基础_

- [x] 2. 实现数据模型和持久化层
  - [x] 2.1 创建数据库迁移脚本
    - 实现 webhook_endpoints 表结构
    - 实现 webhook_events 表结构
    - 实现 idempotency_keys 表结构
    - 实现 transformation_rules 表结构
    - 实现 webhook_executions 表结构
    - 添加必要的索引和约束
    - _需求：1.1, 6.5, 9.1_

  - [x] 2.2 实现数据访问层（Repository 模式）
    - 实现 EndpointRepository（CRUD 操作）
    - 实现 EventRepository（日志记录和查询）
    - 实现 IdempotencyRepository（键存储和查询）
    - 实现 TransformationRuleRepository（规则管理）
    - 实现 ExecutionRepository（执行记录管理）
    - _需求：1.1, 1.3, 6.5, 9.1_

  - [x]* 2.3 编写数据访问层的属性测试
    - **属性 2：端点查询返回所有已注册端点**
    - **属性 22：事件日志持久化往返**
    - **验证需求：1.3, 6.5**

- [x] 3. 实现 WebhookEndpointManager
  - [x] 3.1 实现端点管理核心功能
    - 实现 createEndpoint 方法（生成唯一 ID、URL 和认证令牌）
    - 实现 getEndpoint 方法
    - 实现 updateEndpoint 方法（包含配置验证）
    - 实现 deleteEndpoint 方法
    - 实现 listEndpoints 方法（支持过滤）
    - 实现 validateEndpoint 方法
    - _需求：1.1, 1.2, 1.3, 1.4, 1.5_

  - [x]* 3.2 编写端点管理的属性测试
    - **属性 1：端点创建生成唯一标识和完整配置**
    - **属性 2：端点查询返回所有已注册端点**
    - **属性 3：端点更新验证和持久化**
    - **属性 4：端点删除后不可访问**
    - **验证需求：1.1, 1.2, 1.3, 1.4, 1.5**

  - [x]* 3.3 编写端点管理的单元测试
    - 测试无效配置的拒绝
    - 测试并发创建端点的唯一性
    - 测试端点过滤功能
    - _需求：1.2, 1.3, 1.4_

- [x] 4. 实现 RequestValidator
  - [x] 4.1 实现认证验证功能
    - 实现 Bearer Token 验证
    - 实现 HMAC 签名验证（支持 SHA256 和 SHA512）
    - 实现 Basic Auth 验证
    - 实现请求格式验证
    - _需求：2.1, 2.2_

  - [x] 4.2 实现验证错误处理
    - 实现 401 错误响应（认证失败）
    - 实现 403 错误响应（签名验证失败）
    - 实现 404 错误响应（端点不存在）
    - 实现统一的 ValidationError 格式
    - _需求：2.3, 2.4, 2.5_

  - [x]* 4.3 编写请求验证的属性测试
    - **属性 5：认证令牌验证和错误响应**
    - **属性 6：签名验证和错误响应**
    - **属性 7：未知端点返回 404**
    - **验证需求：2.1, 2.2, 2.3, 2.4, 2.5**

  - [x]* 4.4 编写请求验证的单元测试
    - 测试各种无效 token 格式
    - 测试签名算法的边缘情况
    - 测试请求头缺失的情况
    - _需求：2.1, 2.2, 2.3, 2.4_

- [x] 5. 检查点 - 确保核心组件测试通过
  - 确保所有测试通过，如有问题请询问用户。

- [x] 6. 实现 PayloadTransformer
  - [x] 6.1 实现负载解析器
    - 实现 JSON 解析器
    - 实现 XML 解析器
    - 实现 form-urlencoded 解析器
    - 实现解析错误处理（返回 400 错误）
    - _需求：3.1, 3.2, 3.3, 3.5_

  - [x] 6.2 实现转换规则引擎
    - 实现 JSONPath 字段提取
    - 实现字段类型转换（string, number, boolean, date, json）
    - 实现默认值处理
    - 实现自定义转换逻辑执行（受限 Python 表达式或可审计的规则 DSL）
    - 实现目标模式验证
    - _需求：3.4_

  - [x]* 6.3 编写负载转换的属性测试
    - **属性 8：负载解析正确性**
    - **属性 9：转换规则应用正确性**
    - **属性 10：负载解析失败返回 400**
    - **验证需求：3.1, 3.2, 3.3, 3.4, 3.5**

  - [x]* 6.4 编写负载转换的单元测试
    - 测试复杂嵌套 JSON 结构
    - 测试 XML 命名空间处理
    - 测试特殊字符和编码
    - 测试转换规则的边缘情况
    - _需求：3.1, 3.2, 3.3, 3.4_

- [x] 7. 实现 GovernanceClient
  - [x] 7.1 实现治理层集成接口
    - 实现 checkPermission 方法（调用治理层 API）
    - 实现 checkRateLimit 方法
    - 实现 auditLog 方法
    - 实现治理层不可用时的降级处理
    - _需求：8.1, 8.2_

  - [x] 7.2 实现治理策略应用
    - 实现速率限制检查和拒绝逻辑
    - 实现配额控制
    - 实现执行上下文构建（来源、用户、时间）
    - 实现 403 错误响应（治理拒绝）
    - _需求：8.2, 8.3, 8.4_

  - [x]* 7.3 编写治理集成的属性测试
    - **属性 13：治理层拒绝返回 403**
    - **属性 25：执行前请求治理验证**
    - **属性 26：应用治理策略限制**
    - **验证需求：8.1, 8.2, 8.3, 8.4**

  - [x]* 7.4 编写治理集成的单元测试
    - 测试治理层超时处理
    - 测试治理层返回各种策略限制
    - 测试审计日志的完整性
    - _需求：8.1, 8.2, 8.3_

- [ ] 8. 实现 ExecutionTrigger
  - [ ] 8.1 实现幂等性管理
    - 实现 checkIdempotency 方法（查询幂等性键）
    - 实现 recordIdempotency 方法（记录执行结果，设置 TTL）
    - 实现幂等性键过期清理
    - _需求：9.1, 9.2_

  - [ ] 8.2 实现代理执行触发
    - 实现 trigger 方法（调用 Agent Runtime API）
    - 实现同步执行模式（等待完成）
    - 实现异步执行模式（立即返回）
    - 实现执行超时处理
    - 实现 503 错误响应（运行时不可用）
    - _需求：4.1, 4.2, 4.3, 4.5, 5.4, 5.5_

  - [ ] 8.3 实现重试机制
    - 实现指数退避算法
    - 实现可重试错误判断
    - 实现最大重试次数控制
    - 实现重试状态跟踪
    - _需求：9.3, 9.4, 9.5_

  - [ ] 8.4 实现执行状态查询
    - 实现 getExecutionStatus 方法
    - 实现执行结果缓存
    - _需求：4.3_

  - [ ]* 8.5 编写执行触发的属性测试
    - **属性 11：验证通过后触发代理执行**
    - **属性 12：执行启动返回执行信息**
    - **属性 14：运行时不可用返回 503**
    - **属性 17：同步模式等待完成**
    - **属性 18：异步模式立即返回**
    - **属性 27：幂等性键检查**
    - **属性 28：幂等性保证**
    - **属性 29：失败自动重试**
    - **验证需求：4.1, 4.2, 4.3, 4.5, 5.4, 5.5, 9.1, 9.2, 9.3, 9.4**

  - [ ]* 8.6 编写执行触发的单元测试
    - 测试并发请求的幂等性
    - 测试重试延迟的正确性
    - 测试同步模式的超时处理
    - 测试执行结果的缓存
    - _需求：4.3, 5.4, 9.2, 9.3_

- [ ] 9. 检查点 - 确保执行层测试通过
  - 确保所有测试通过，如有问题请询问用户。

- [ ] 10. 实现 EventLogger
  - [ ] 10.1 实现事件日志记录
    - 实现 logRequest 方法（记录请求信息）
    - 实现 logValidation 方法（记录验证结果）
    - 实现 logTransformation 方法（记录转换过程）
    - 实现 logExecution 方法（记录执行状态和结果）
    - 实现错误日志记录（包含堆栈跟踪）
    - _需求：6.1, 6.2, 6.3, 6.4_

  - [ ] 10.2 实现事件查询接口
    - 实现 queryEvents 方法（支持多种过滤条件）
    - 实现分页查询
    - 实现时间范围查询
    - 实现按端点和状态过滤
    - _需求：6.5_

  - [ ]* 10.3 编写事件日志的属性测试
    - **属性 19：请求处理完整日志**
    - **属性 20：执行完成日志**
    - **属性 21：错误日志详细信息**
    - **属性 22：事件日志持久化往返**
    - **属性 30：重试日志记录**
    - **验证需求：6.1, 6.2, 6.3, 6.4, 6.5, 9.5**

  - [ ]* 10.4 编写事件日志的单元测试
    - 测试大量日志的查询性能
    - 测试日志过滤的准确性
    - 测试日志分页功能
    - _需求：6.5_

- [ ] 11. 实现 MonitoringService
  - [ ] 11.1 实现指标记录和统计
    - 实现 recordMetric 方法（记录请求计数、响应时间等）
    - 实现指标聚合（成功率、失败率、平均响应时间、P95、P99）
    - 实现时间窗口统计（实时、小时、天）
    - _需求：7.2_

  - [ ] 11.2 实现健康检查
    - 实现 getHealthStatus 方法
    - 实现数据库连接检查
    - 实现 Agent Runtime 连接检查
    - 实现 Governance Layer 连接检查
    - _需求：7.1_

  - [ ] 11.3 实现告警机制
    - 实现阈值检查（失败率、响应时间）
    - 实现 triggerAlert 方法
    - 实现告警去重和聚合
    - 实现告警通知接口（Webhook、邮件等）
    - _需求：7.3, 7.4_

  - [ ] 11.4 实现监控数据查询
    - 实现 getMetrics 方法（支持时间范围和过滤）
    - 实现实时指标查询
    - 实现历史指标查询
    - _需求：7.5_

  - [ ]* 11.5 编写监控服务的属性测试
    - **属性 23：监控指标记录**
    - **属性 24：指标超过阈值触发告警**
    - **验证需求：7.2, 7.3, 7.4, 7.5**

  - [ ]* 11.6 编写监控服务的单元测试
    - 测试健康检查端点的响应格式
    - 测试指标聚合的准确性
    - 测试告警去重逻辑
    - _需求：7.1, 7.2, 7.3_

- [ ] 12. 实现 HTTP 接入层（API Gateway）
  - [ ] 12.1 实现 HTTP 服务器和路由
    - 设置 FastAPI 或 Starlette 服务器
    - 实现 Webhook 接收路由（POST /webhooks/:endpointId）
    - 实现端点管理路由（CRUD 操作）
    - 实现健康检查路由（GET /health）
    - 实现监控指标路由（GET /metrics）
    - _需求：1.1, 7.1_

  - [ ] 12.2 实现请求处理流程
    - 实现请求 ID 生成和追踪
    - 实现请求日志记录（来源 IP、User-Agent）
    - 实现 TLS 配置
    - 实现 CORS 配置
    - _需求：6.1_

  - [ ] 12.3 实现速率限制中间件
    - 实现基于 IP 的速率限制
    - 实现基于端点的速率限制
    - 实现 429 错误响应
    - _需求：8.2_

  - [ ] 12.4 实现响应处理
    - 实现统一的成功响应格式（202 Accepted）
    - 实现统一的错误响应格式
    - 实现响应时间记录
    - _需求：5.1, 5.2, 5.3_

  - [ ]* 12.5 编写 HTTP 接入层的属性测试
    - **属性 15：成功启动返回 202**
    - **属性 16：错误处理返回适当状态码**
    - **验证需求：5.1, 5.2, 5.3**

  - [ ]* 12.6 编写 HTTP 接入层的集成测试
    - 测试完整的请求处理流程
    - 测试各种错误场景的端到端处理
    - 测试速率限制的有效性
    - _需求：2.1, 3.1, 4.1, 5.1_

- [ ] 13. 实现配置管理
  - [ ] 13.1 实现配置加载和验证
    - 实现配置文件解析（YAML 或 JSON）
    - 实现配置模式验证
    - 实现环境变量覆盖
    - 实现配置默认值
    - _需求：10.1, 10.3_

  - [ ] 13.2 实现配置热更新
    - 实现配置文件监听
    - 实现配置更新通知
    - 实现配置应用（不中断服务）
    - _需求：10.4_

  - [ ] 13.3 实现配置版本管理
    - 实现配置版本记录
    - 实现配置回滚功能
    - 实现配置变更历史查询
    - _需求：10.5_

  - [ ]* 13.4 编写配置管理的属性测试
    - **属性 31：配置加载和应用**
    - **属性 32：端点独立配置**
    - **属性 33：配置版本回滚往返**
    - **验证需求：10.1, 10.2, 10.3, 10.5**

  - [ ]* 13.5 编写配置管理的单元测试
    - 测试无效配置的拒绝
    - 测试配置热更新的正确性
    - 测试配置回滚功能
    - _需求：10.3, 10.4, 10.5_

- [ ] 14. 检查点 - 确保所有组件集成正确
  - 确保所有测试通过，如有问题请询问用户。

- [ ] 15. 实现端到端集成和最终测试
  - [ ] 15.1 实现主应用入口
    - 实现应用启动流程（初始化所有组件）
    - 实现依赖注入容器
    - 实现优雅关闭（Graceful Shutdown）
    - 实现启动健康检查
    - _需求：所有需求_

  - [ ] 15.2 实现数据库迁移和种子数据
    - 实现数据库迁移脚本执行
    - 实现种子数据加载（用于开发和测试）
    - 实现数据库版本管理
    - _需求：1.1_

  - [ ]* 15.3 编写端到端集成测试
    - 测试完整的 Webhook 请求处理流程（从接收到执行）
    - 测试多端点并发处理
    - 测试幂等性在并发场景下的正确性
    - 测试重试机制的端到端行为
    - 测试治理层集成的完整流程
    - _需求：所有需求_

  - [ ]* 15.4 编写性能和压力测试
    - 测试高并发请求处理能力
    - 测试大负载解析性能
    - 测试数据库查询性能
    - 测试内存使用和泄漏
    - _需求：7.2_

- [ ] 16. 文档和部署准备
  - [ ] 16.1 编写 API 文档
    - 编写 OpenAPI/Swagger 规范
    - 编写端点使用示例
    - 编写认证配置指南
    - 编写转换规则配置指南
    - _需求：1.1, 2.1, 3.4_

  - [ ] 16.2 编写部署文档
    - 编写 Docker 镜像构建说明
    - 编写 Kubernetes 部署配置
    - 编写环境变量配置说明
    - 编写数据库迁移说明
    - _需求：所有需求_

  - [ ] 16.3 编写运维文档
    - 编写监控和告警配置指南
    - 编写故障排查指南
    - 编写性能调优指南
    - 编写备份和恢复流程
    - _需求：7.1, 7.2, 7.3_

- [ ] 17. 最终检查点 - 确保所有测试通过并准备部署
  - 确保所有测试通过，如有问题请询问用户。

## 注意事项

- 标记为 `*` 的任务建议优先执行；若暂缓，必须在 spec 循环中明确记录原因与回补计划
- 每个任务都引用了具体的需求以确保可追溯性
- 检查点确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证特定示例和边缘情况
- 集成测试验证组件间的交互
