# Requirements: Contract Testing

> **目标**：构建 API + MCP 契约测试体系，确保协议演进可验证、可阻断、可回放。  
> **优先级**：P0  
> **预估工作量**：4-6 天

---

## 1. 背景

现有测试更偏功能行为，协议层“兼容性回归”与“差异阻断”尚不完善。

## 2. 功能需求

### FR-1 API 契约差异检测
- [ ] OpenAPI diff 进入 PR 检查
- [ ] breaking 检测默认阻断

### FR-2 MCP 契约回归
- [ ] initialize/tools/resources/read 核心路径回归
- [ ] 错误语义回归

### FR-3 对齐矩阵
- [ ] 建立 API/MCP 对齐矩阵并纳入评审

### FR-4 报告可追溯
- [ ] 每次 CI 输出契约变更报告

## 3. 非功能需求

- **NFR-1**：本地与 CI 运行结果一致
- **NFR-2**：测试可并行执行且可复现

## 4. DoD

- [ ] API/MCP 契约测试纳入 CI 必跑
- [ ] breaking 注入演练被阻断
- [ ] 差异报告归档可追溯

---

## 5. 量化阈值与验收矩阵

### 5.1 量化阈值

- PR 最小契约集耗时：`<= 8 分钟`。
- nightly 全量回归耗时：`<= 45 分钟`。
- 契约回归关键路径（API3 + MCP4）覆盖：`100%`。

### 5.2 验收矩阵

| 场景 | 检查项 | 证据 | 通过 |
|------|--------|------|------|
| OpenAPI breaking | PR 被阻断 | CI 记录 | [ ] |
| MCP 错误回归 | 字段一致 | 测试报告 | [ ] |
| 行为回放 | 结果稳定 | replay 报告 | [ ] |
| 报告归档 | 可追溯 | artifact 链接 | [ ] |

---

**维护者**：测试架构组  
**最后更新**：2026-02-26
