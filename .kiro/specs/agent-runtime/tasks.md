# 实现计划：agent-runtime

## 文档联动

- requirements: `.kiro/specs/agent-runtime/requirements.md`
- design: `.kiro/specs/agent-runtime/design.md`
- tasks: `.kiro/specs/agent-runtime/tasks.md`
- status source: `.kiro/specs/SPEC_TASKS_SCAN.md`


## 概述

本实现计划将 agent-runtime 设计分解为离散的编码步骤。Agent 运行时是 OwlClaw 的核心，负责 Agent 的身份加载、记忆系统、知识注入、function calling 决策循环和 Heartbeat 机制。

实现策略：
1. 先实现核心数据结构和接口
2. 然后实现各个子系统（Identity、Memory、Knowledge、Heartbeat）
3. 最后实现主 AgentRuntime 类和决策循环
4. 每个子系统实现后立即编写测试（单元测试 + 属性测试）

## 任务

- [x] 1. 设置项目结构和核心数据模型
  - 创建 `owlclaw/agent/runtime/` 目录结构
  - 定义 `AgentRunContext` 数据类
  - 定义核心接口和类型
  - _需求：所有需求的基础_

- [x] 2. 实现 IdentityLoader 类
  - [x] 2.1 实现 SOUL.md 和 IDENTITY.md 加载
    - 实现文件读取和验证
    - 实现 capabilities summary 提取
    - _需求：1.1, 1.2, 1.3, 1.4_
  
  - [x]* 2.2 编写 IdentityLoader 的单元测试
    - 测试文件加载成功场景
    - 测试文件缺失错误场景
    - 测试 capabilities summary 提取
    - _需求：1.1, 1.2, 1.3, 1.4_
  
  - [x]* 2.3 编写属性测试：身份文件加载完整性
    - **Property 1: 身份文件加载完整性**
    - **验证：需求 1.1, 1.2, 1.7, 1.8**
  
  - [x]* 2.4 编写属性测试：身份文件缺失错误处理
    - **Property 2: 身份文件缺失错误处理**
    - **验证：需求 1.3, 1.4**
  
  - [x] 2.5 实现热重载功能
    - 实现 `reload()` 方法
    - _需求：1.9_
  
  - [x]* 2.6 编写属性测试：身份热重载一致性
    - **Property 3: 身份热重载一致性**
    - **验证：需求 1.9**

- [ ] 3. 实现 MemorySystem 类
  - [ ] 3.1 实现短期记忆管理
    - 实现 `build_short_term_context()` 方法
    - 实现 `add_short_term()` 方法
    - 实现 token 限制和自动压缩
    - _需求：2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7_
  
  - [ ]* 3.2 编写属性测试：短期记忆 token 限制
    - **Property 4: 短期记忆 token 限制**
    - **验证：需求 2.6**
  
  - [ ]* 3.3 编写属性测试：短期记忆自动压缩
    - **Property 5: 短期记忆自动压缩**
    - **验证：需求 2.7**
  
  - [ ] 3.4 实现长期记忆写入（MEMORY.md + 向量数据库）
    - 实现 `write()` 方法
    - 实现 MEMORY.md 追加写入
    - 实现向量数据库索引
    - _需求：3.1, 3.2, 3.3, 3.4_
  
  - [ ] 3.5 实现长期记忆搜索
    - 实现 `search()` 方法
    - 实现 `recall_relevant()` 方法
    - 实现向量搜索和时间衰减
    - _需求：3.5, 3.6, 3.7_
  
  - [ ]* 3.6 编写属性测试：长期记忆写入完整性（Round-trip）
    - **Property 6: 长期记忆写入完整性（Round-trip）**
    - **验证：需求 3.2, 3.3, 3.4**
  
  - [ ]* 3.7 编写属性测试：长期记忆向量搜索相关性
    - **Property 7: 长期记忆向量搜索相关性**
    - **验证：需求 3.5, 3.6**
  
  - [ ] 3.8 实现 MEMORY.md 文件大小限制和归档
    - 实现文件大小检查
    - 实现自动归档逻辑
    - _需求：3.8, 3.9_
  
  - [ ]* 3.9 编写属性测试：MEMORY.md 文件大小限制
    - **Property 8: MEMORY.md 文件大小限制**
    - **验证：需求 3.8, 3.9**
  
  - [ ]* 3.10 编写 MemorySystem 的单元测试
    - 测试短期记忆构建
    - 测试长期记忆读写
    - 测试向量搜索
    - 测试文件归档
    - _需求：2.1-2.9, 3.1-3.11_


- [ ] 4. 实现 KnowledgeInjector 类
  - [ ] 4.1 实现 Skills metadata 加载
    - 实现 `load_skills_metadata()` 方法
    - 实现 SKILL.md frontmatter 解析（YAML）
    - 实现 Agent Skills 规范验证
    - _需求：4.1, 4.2, 4.3, 4.11_
  
  - [ ]* 4.2 编写属性测试：Skills 格式验证
    - **Property 9: Skills 格式验证**
    - **验证：需求 4.1, 4.11**
  
  - [ ] 4.3 实现 Skills 选择和注入
    - 实现 `select_skills()` 方法
    - 实现渐进式加载（metadata → full content）
    - 实现 token 限制
    - _需求：4.4, 4.5, 4.6, 4.7, 4.8, 4.9_
  
  - [ ]* 4.4 编写属性测试：Skills token 限制
    - **Property 10: Skills token 限制**
    - **验证：需求 4.8**
  
  - [ ] 4.5 实现 Skills 热重载
    - 实现 `reload_skills()` 方法
    - 清理内容缓存
    - _需求：4.10_
  
  - [ ]* 4.6 编写 KnowledgeInjector 的单元测试
    - 测试 metadata 加载
    - 测试 Skills 选择逻辑
    - 测试 token 限制
    - 测试热重载
    - _需求：4.1-4.11_

- [x] 5. 实现 HeartbeatChecker 类
  - [x] 5.1 实现事件源检查框架
    - 实现 `check_events()` 方法
    - 实现 `_check_source()` 方法
    - 定义事件源接口
    - _需求：7.1, 7.2, 7.3, 7.6_
  
  - [x] 5.2 实现各事件源的检查逻辑
    - 实现 webhook 事件检查（MVP: 占位返回 False）
    - 实现 queue 事件检查（MVP: 占位返回 False）
    - 实现 database 事件检查（MVP: 占位返回 False）
    - 实现 schedule 事件检查（MVP: 占位返回 False）
    - _需求：7.6_
  
  - [x]* 5.3 编写 HeartbeatChecker 的单元测试
    - 测试无事件场景
    - 测试有事件场景（子类覆盖）
    - 测试各事件源检查
    - _需求：7.1-7.9_

- [x] 6. 实现 AgentRuntime 核心类
  - [x] 6.1 实现初始化和设置
    - 实现 `__init__()` 方法
    - 实现 `setup()` 方法
    - 初始化所有子系统
    - _需求：所有需求的基础_
  
  - [x] 6.2 实现 system prompt 构建
    - 实现 `_build_system_prompt()` 方法
    - 整合身份、记忆、知识、工具
    - _需求：1.7, 1.8, 2.8, 4.6_
  
  - [x] 6.3 实现可见工具列表构建
    - 实现 `_get_visible_tools()` 方法
    - 整合业务能力（governance filter 可选）
    - 调用治理层过滤（可选，无治理则返回全部）
    - _需求：6.1, 6.2, 6.3, 6.4, 6.5, 6.6, 6.7, 6.8, 6.9, 6.10_
  
  - [ ]* 6.4 编写属性测试：工具可见性过滤日志
    - **Property 13: 工具可见性过滤日志**
    - **验证：需求 6.11**

- [x] 7. 实现 LLM function calling 决策循环
  - [x] 7.1 实现工具执行
    - 实现 `_execute_tool()` 方法
    - 路由到业务能力（内建工具 Task 10 后补）
    - 实现错误处理和传播
    - _需求：5.4, 5.5, 5.6, 12.5_
  
  - [ ]* 7.2 编写属性测试：工具错误传播
    - **Property 21: 工具错误传播**
    - **验证：需求 12.5**
  
  - [x] 7.3 实现决策循环主逻辑
    - 实现 `_decision_loop()` 方法
    - 实现 LLM function calling 循环（litellm.acompletion）
    - 实现 function call 次数限制（max_function_calls）
    - _需求：5.1, 5.2, 5.3, 5.7, 5.8, 5.9, 5.10, 5.11_
  
  - [ ]* 7.4 编写属性测试：Function calling 次数限制
    - **Property 11: Function calling 次数限制**
    - **验证：需求 5.8, 5.9**
  
  - [ ]* 7.5 编写属性测试：LLM 调用超时控制
    - **Property 12: LLM 调用超时控制**
    - **验证：需求 5.12, 5.13**

- [x] 8. 实现 Agent Run 主流程
  - [x] 8.1 实现 Heartbeat 检查集成
    - 在 `run()` 方法中集成 Heartbeat 检查
    - 实现无事件跳过逻辑（trigger=heartbeat 且 check_events() 为 False 时返回 skipped）
    - _需求：7.4, 7.5, 7.8_
  
  - [ ]* 8.2 编写属性测试：Heartbeat 无事件优化
    - **Property 14: Heartbeat 无事件优化**
    - **验证：需求 7.4**
  
  - [ ]* 8.3 编写属性测试：Heartbeat 有事件触发
    - **Property 15: Heartbeat 有事件触发**
    - **验证：需求 7.5**
  
  - [x] 8.4 实现 Agent Run 生命周期管理
    - 实现生命周期阶段定义（setup/run/completed）
    - 实现阶段转换日志
    - 实现 run 状态更新（status 字段）
    - _需求：8.1, 8.2, 8.3, 8.4, 8.5_
  
  - [ ]* 8.5 编写属性测试：Agent Run 超时控制
    - **Property 16: Agent Run 超时控制**
    - **验证：需求 8.8, 8.9**
  
  - [ ] 8.6 实现 Langfuse tracing 集成
    - 在 `run()` 方法中创建 trace
    - 在工具执行中创建 span
    - 记录错误和事件
    - _需求：11.1, 11.2, 11.3, 11.4, 11.5, 11.6, 11.7, 11.8, 11.9, 11.10_
  
  - [ ]* 8.7 编写属性测试：Langfuse trace 创建
    - **Property 19: Langfuse trace 创建**
    - **验证：需求 11.2, 11.3, 11.4**
  
  - [ ]* 8.8 编写 AgentRuntime 的单元测试
    - 测试初始化和设置
    - 测试 system prompt 构建
    - 测试决策循环
    - 测试生命周期管理
    - 测试 Langfuse 集成
    - _需求：所有核心需求_


- [ ] 9. 实现与 Hatchet 的集成
  - [ ] 9.1 实现 Agent Run 作为 Hatchet task
    - 注册 Agent Run 为 Hatchet task
    - 实现 task handler
    - 实现 payload 解析
    - _需求：9.1, 9.2_
  
  - [ ] 9.2 实现 Hatchet 高级功能集成
    - 实现持久化 sleep 支持
    - 实现任务调度支持
    - 实现 cron 触发器支持
    - 实现 Signal 机制支持
    - _需求：9.3, 9.4, 9.5, 9.6_
  
  - [ ] 9.3 实现 Hatchet 重试和并发控制
    - 配置重试策略
    - 配置并发控制（同一 Agent 串行）
    - 同步 run 状态到 Hatchet Dashboard
    - _需求：9.7, 9.8, 9.9_
  
  - [ ]* 9.4 编写属性测试：Hatchet 任务重试
    - **Property 17: Hatchet 任务重试**
    - **验证：需求 9.7**
  
  - [ ]* 9.5 编写 Hatchet 集成的单元测试
    - 测试 task 注册
    - 测试 payload 解析
    - 测试重试策略
    - 测试并发控制
    - _需求：9.1-9.10_

- [ ] 10. 实现与 litellm 的集成
  - [ ] 10.1 实现 LLM 客户端封装
    - 封装 litellm.completion() 调用
    - 实现 function calling 支持
    - 实现流式响应支持
    - _需求：10.1, 10.2, 10.3, 10.4_
  
  - [ ] 10.2 实现 LLM 重试和降级
    - 实现重试策略
    - 实现模型降级链
    - 实现超时和取消
    - _需求：10.5, 10.8, 12.4_
  
  - [ ] 10.3 实现 LLM 调用的治理集成
    - 集成 Governance Router（模型选择）
    - 集成 Langfuse tracing
    - 记录 token 使用量到 Ledger
    - _需求：10.6, 10.7, 10.9_
  
  - [ ]* 10.4 编写属性测试：Token 使用量记录
    - **Property 18: Token 使用量记录**
    - **验证：需求 10.9**
  
  - [ ]* 10.5 编写 litellm 集成的单元测试
    - 测试 LLM 调用
    - 测试 function calling
    - 测试重试和降级
    - 测试 token 记录
    - _需求：10.1-10.10_

- [ ] 11. 实现错误处理和容错
  - [ ] 11.1 实现初始化错误处理
    - 处理文件加载失败
    - 处理 SKILL.md 格式错误
    - _需求：12.1, 12.2_
  
  - [ ] 11.2 实现运行时错误处理
    - 处理 LLM 调用失败
    - 处理向量数据库连接失败（降级）
    - 处理工具执行失败
    - _需求：12.3, 12.4, 12.5_
  
  - [ ]* 11.3 编写属性测试：向量数据库降级
    - **Property 20: 向量数据库降级**
    - **验证：需求 12.3**
  
  - [ ] 11.4 实现错误分类和处理策略
    - 定义可重试错误和不可重试错误
    - 实现错误处理策略
    - 实现错误日志和 Ledger 记录
    - _需求：12.6, 12.7, 12.8, 12.9_
  
  - [ ] 11.5 实现错误告警通知
    - 实现告警配置
    - 实现告警发送
    - _需求：12.10_
  
  - [ ]* 11.6 编写错误处理的单元测试
    - 测试各种错误场景
    - 测试降级逻辑
    - 测试错误记录
    - _需求：12.1-12.10_

- [ ] 12. 实现配置和可定制性
  - [ ] 12.1 实现配置文件加载
    - 实现 owlclaw.yaml 解析
    - 实现配置验证
    - _需求：14.1, 14.11_
  
  - [ ]* 12.2 编写属性测试：配置验证
    - **Property 22: 配置验证**
    - **验证：需求 14.11**
  
  - [ ] 12.3 实现各配置项支持
    - 实现 LLM 模型配置
    - 实现记忆系统配置
    - 实现 token 限制配置
    - 实现超时配置
    - 实现重试策略配置
    - 实现 Heartbeat 配置
    - 实现并发控制配置
    - 实现日志配置
    - _需求：14.2, 14.3, 14.4, 14.5, 14.6, 14.7, 14.8, 14.9_
  
  - [ ] 12.4 实现配置热重载
    - 实现部分配置的热重载
    - 实现配置变更通知
    - _需求：14.10_
  
  - [ ]* 12.5 编写配置系统的单元测试
    - 测试配置加载
    - 测试配置验证
    - 测试配置热重载
    - _需求：14.1-14.11_

- [ ] 13. 实现安全机制
  - [ ] 13.1 实现输入 sanitization
    - 实现文件内容清理
    - 实现 prompt injection 防护
    - _需求：16.1, 16.2, 16.3_
  
  - [ ]* 13.2 编写属性测试：输入内容清理
    - **Property 23: 输入内容清理**
    - **验证：需求 16.1, 16.2, 16.3**
  
  - [ ] 13.3 实现文件路径限制
    - 实现路径验证
    - 实现沙箱限制
    - _需求：16.4_
  
  - [ ] 13.4 实现参数验证
    - 实现工具参数验证
    - 实现类型和范围检查
    - _需求：16.5_
  
  - [ ] 13.5 实现审计日志
    - 实现 Agent Run 审计日志
    - 实现数据访问隔离
    - _需求：16.6, 16.8_
  
  - [ ] 13.6 实现权限控制和速率限制
    - 实现权限控制（企业版）
    - 实现速率限制
    - 实现敏感数据加密
    - _需求：16.7, 16.9, 16.10_
  
  - [ ]* 13.7 编写安全机制的单元测试
    - 测试 sanitization
    - 测试路径限制
    - 测试参数验证
    - 测试审计日志
    - _需求：16.1-16.10_

- [ ] 14. 实现性能优化
  - [ ] 14.1 实现缓存机制
    - 实现 Skills metadata 缓存
    - 实现 Skills content 缓存
    - 实现向量搜索缓存
    - 实现 LLM 响应缓存（可选）
    - _需求：13.3, 13.4, 13.5_
  
  - [ ] 14.2 实现资源限制
    - 实现内存使用限制
    - 实现并发控制
    - _需求：13.6, 13.7_
  
  - [ ] 14.3 实现性能监控
    - 实现性能指标收集
    - 实现限流机制
    - _需求：13.8, 13.9_
  
  - [ ]* 14.4 编写性能测试
    - 测试 Agent Run 启动延迟
    - 测试向量搜索延迟
    - 测试并发吞吐量
    - _需求：13.1-13.10_

- [ ] 15. Checkpoint - 确保所有测试通过
  - 运行所有单元测试
  - 运行所有属性测试
  - 检查测试覆盖率（> 80%）
  - 修复所有失败的测试
  - 如有问题，询问用户

- [ ] 16. 编写集成测试
  - [ ] 16.1 编写 Hatchet 集成测试
    - 测试 Agent Run 作为 Hatchet task
    - 测试任务调度和重试
    - _需求：9.1-9.10_
  
  - [ ] 16.2 编写 litellm 集成测试
    - 测试真实 LLM 调用（使用测试 API key）
    - 测试 function calling
    - _需求：10.1-10.10_
  
  - [ ] 16.3 编写向量数据库集成测试
    - 测试真实向量搜索（pgvector 测试实例）
    - 测试记忆读写
    - _需求：3.1-3.11_
  
  - [ ] 16.4 编写 Langfuse 集成测试
    - 测试真实 trace 创建（测试项目）
    - 测试 span 记录
    - _需求：11.1-11.11_

- [ ] 17. 编写端到端测试
  - [ ] 17.1 编写完整 Agent Run 流程测试
    - 测试从触发到完成的完整流程
    - 测试 LLM function calling 循环
    - 测试工具执行和结果返回
    - _需求：所有核心需求_
  
  - [ ] 17.2 编写 Heartbeat 机制测试
    - 测试无事件跳过 LLM
    - 测试有事件触发完整 run
    - _需求：7.1-7.9_
  
  - [ ] 17.3 编写热重载测试
    - 测试身份热重载
    - 测试 Skills 热重载
    - _需求：1.9, 4.10_
  
  - [ ] 17.4 编写记忆系统测试
    - 测试 remember → recall round-trip
    - 测试向量搜索相关性
    - _需求：3.1-3.11_
  
  - [ ] 17.5 编写错误恢复测试
    - 测试 LLM 失败降级
    - 测试向量 DB 失败降级
    - 测试 Hatchet 任务重试
    - _需求：12.1-12.10_

- [ ] 18. Final Checkpoint - 确保所有测试通过
  - 运行所有单元测试
  - 运行所有属性测试
  - 运行所有集成测试
  - 运行所有端到端测试
  - 检查测试覆盖率（> 80%）
  - 修复所有失败的测试
  - 如有问题，询问用户

- [ ] 19. 编写文档和示例
  - [ ] 19.1 编写 API 文档
    - 为所有公共类和方法编写 docstring
    - 生成 API 文档（Sphinx）
  
  - [ ] 19.2 编写使用指南
    - 编写快速开始指南
    - 编写配置指南
    - 编写故障排查指南
  
  - [ ] 19.3 编写示例代码
    - 编写基本 Agent Run 示例
    - 编写 Heartbeat 示例
    - 编写记忆系统示例
    - 编写 Skills 注入示例

## 注意事项

- 标记为 `*` 的任务用于标识测试/验证重点，不代表可选；纳入交付范围时必须完成
- 每个任务都引用了具体的需求编号，便于追溯
- 属性测试使用 Hypothesis 库，每个测试最少 100 次迭代
- 单元测试使用 pytest + pytest-asyncio
- 集成测试需要 Docker Compose 环境（Hatchet + PostgreSQL + pgvector）
- 端到端测试需要真实的 API keys（LLM、Langfuse）
- Checkpoint 任务确保增量验证，及时发现问题

