# Requirements: Protocol Governance

> **目标**：建立 OwlClaw API + MCP 的统一协议治理体系（版本、兼容、错误域、弃用、门禁），把协议演进变成可执行工程纪律。  
> **优先级**：P0  
> **预估工作量**：4-6 天

---

## 1. 背景与动机

### 1.1 当前问题

- 协议策略分散在不同文档与实现中，缺少统一“单一真源”。
- API 与 MCP 的错误语义存在理解差异，客户端难以复用重试与降级逻辑。
- 协议变更尚未形成“可自动阻断”的 CI 治理闭环。

### 1.2 设计目标

- 统一版本策略、兼容规则、弃用流程与错误域。
- 将规则映射为 CI 门禁（warning -> blocking）。
- 让跨语言客户端可基于 machine-readable 字段稳定处理错误与升级。

---

## 2. 用户故事

### 2.1 作为平台架构师

```
作为 平台架构师
我希望协议变更有统一分级和门禁
这样我可以降低 breaking change 对客户端的冲击
```

**验收标准**：
- [ ] 变更分级规则形成规范并被工具执行。
- [ ] 无迁移计划的 breaking change 无法通过主分支门禁。

### 2.2 作为客户端开发者

```
作为 客户端开发者
我希望 API 与 MCP 错误语义一致
这样我可以复用统一的重试/告警逻辑
```

**验收标准**：
- [ ] API 与 MCP 错误映射矩阵完整。
- [ ] 错误对象含 `category/retryable/incident_id`。

### 2.3 作为发布负责人

```
作为 发布负责人
我希望协议升级有明确弃用窗口和回滚标准
这样我可以安全推进版本演进
```

**验收标准**：
- [ ] 弃用窗口、公告周期、回滚条件文档化并演练。

---

## 3. 功能需求

### FR-1：统一版本治理

**需求**：定义 API 版本策略与 MCP 协商策略，并绑定同一 release policy。

**验收标准**：
- [ ] 产出 `docs/protocol/VERSIONING.md`。
- [ ] 明确版本选择优先级（请求指定 > 默认版本 > 协商降级）。
- [ ] 提供升级与降级示例。

### FR-2：兼容性政策

**需求**：定义变更级别、判定标准、迁移要求、弃用流程。

**验收标准**：
- [ ] 产出 `docs/protocol/COMPATIBILITY_POLICY.md`。
- [ ] `compatible/additive/breaking` 判定规则可工具化。
- [ ] breaking 变更必须携带迁移方案与窗口。

### FR-3：统一错误域

**需求**：统一 API 与 MCP 错误语义，保证客户端可机器处理。

**验收标准**：
- [ ] 产出 `docs/protocol/ERROR_MODEL.md`。
- [ ] 定义错误分类、可重试语义、告警级别。
- [ ] API 与 MCP 的映射表可用于自动测试。

### FR-4：治理门禁政策

**需求**：定义协议治理的 CI Gate 策略与升级路径。

**验收标准**：
- [ ] 产出 `docs/protocol/GOVERNANCE_GATE_POLICY.md`。
- [ ] 门禁阶段从 warning 平滑切换到 blocking。
- [ ] 明确豁免流程与审计要求。

---

## 4. 非功能需求

- **NFR-1 可追溯性**：所有规则变更可追溯到 PR 与审批记录。
- **NFR-2 一致性**：API/MCP 错误字段语义一致，禁止双标准。
- **NFR-3 可执行性**：每条治理规则能映射到自动化检查。

---

## 5. 验收标准总览

### 5.1 功能验收
- [ ] FR-1 版本治理文档与示例完成
- [ ] FR-2 兼容政策文档与判定规则完成
- [ ] FR-3 错误域文档与映射表完成
- [ ] FR-4 CI Gate 政策完成

### 5.2 测试验收
- [ ] breaking 变更注入被门禁阻断
- [ ] API/MCP 错误映射回归通过

### 5.3 文档验收
- [ ] 协议治理四文档齐全并互相引用

---

## 6. 约束与假设

### 6.1 约束
- 不破坏现有已发布行为的默认兼容性。
- 不引入与 `mcp-server`/`triggers-api` 冲突的版本语义。

### 6.2 假设
- CI 能支持新增契约门禁任务。
- 审校工作流允许“策略例外”并记录审计。

---

## 7. 风险与缓解

### 风险 1：规则过严导致研发速度下降
- 缓解：先 warning 再 blocking，设置过渡期。

### 风险 2：规则过松导致兼容事故
- 缓解：红军注入演练 + 强制迁移窗口。

---

## 8. Definition of Done

- [ ] 四份治理文档完成并评审通过。
- [ ] CI 中出现至少一条有效阻断记录。
- [ ] 错误域一致性测试通过并出具报告。
- [ ] 完成一次“breaking 注入 + 回滚策略验证”演练。

---

## 9. 量化阈值与验收矩阵

### 9.1 量化阈值

- `breaking` 检测漏报率目标：`0`（演练样本内）。
- 策略门禁决策延迟目标：`< 60s`（单次 CI 任务）。
- 错误域一致性覆盖：核心协议错误码 `100%` 覆盖（API/MCP 对照）。

### 9.2 验收矩阵

| 场景 | 检查项 | 证据 | 通过 |
|------|--------|------|------|
| breaking 变更注入 | gate 阻断 | CI 日志 + diff 报告 | [ ] |
| additive 变更 | gate 允许并告警 | CI 日志 | [ ] |
| 错误映射回归 | API/MCP 字段一致 | 测试报告 | [ ] |
| 例外审批 | 豁免有审计链路 | PR 记录 | [ ] |

---

**维护者**：OwlClaw 架构组  
**最后更新**：2026-02-26
