# Requirements: Protocol-first API + MCP

> **目标**：将 OwlClaw 的下一阶段主线从 SDK-first 切换为 Protocol-first（API + MCP），形成跨语言可接入、可演进、可治理的标准产品面。  
> **优先级**：P0  
> **状态**：已完成（通过子 spec 汇总验收）  
> **预估工作量**：10-15 天

---

## 1. 背景与动机

### 1.1 当前问题

- 现有能力已具备较强 Python SDK 体验，但协议面（统一 API 契约、MCP 能力面、版本演进策略）未形成统一治理闭环。
- Java/Go/.NET 等非 Python 团队接入路径不够清晰，存在“看得懂能力，接不动系统”的落地摩擦。
- 协议变更尚未形成“兼容性门禁 + 自动化回归”的发布纪律，长期存在演进风险。

### 1.2 设计目标

- 建立 API + MCP 的统一产品面（Gateway-first），SDK 退为语法糖层。
- 固化版本策略、错误模型、兼容性规则和弃用流程，降低跨版本破坏风险。
- 提供至少一条非 Python Golden Path（Java 优先）并具备可执行验收。

---

## 2. 用户故事

### 2.1 作为平台架构师

**故事 1**：统一协议面治理
```
作为 平台架构师
我希望 OwlClaw 的 API 与 MCP 采用统一的契约和版本治理
这样我可以在多语言生态中稳定推进能力演进而不频繁破坏客户端
```

**验收标准**：
- [x] API 版本策略、MCP 版本协商与兼容性规则形成文档化标准并落地到 CI 门禁。
- [x] 任何协议级 breaking change 都能被自动检测并阻断。

### 2.2 作为 Java 开发者

**故事 2**：无需 Python SDK 也能接入
```
作为 Java 开发者
我希望通过 HTTP/MCP 契约直接接入 OwlClaw
这样我无需引入 Python 运行时也能调用 Agent 能力并拿到可追踪结果
```

**验收标准**：
- [x] 提供 Java/curl 的协议调用样例并在 CI 或本地脚本中验证通过。
- [x] 至少 3 个核心场景（触发、查询、审计）可通过协议调用完成。

### 2.3 作为平台运维

**故事 3**：协议发布可回滚
```
作为 平台运维
我希望协议升级可以分阶段发布并可快速回滚
这样我可以控制故障爆炸半径并保持服务稳定
```

**验收标准**：
- [x] 具备分阶段发布门控（canary -> 扩量 -> 全量）与回滚标准。
- [x] 协议层 SLO 与错误预算可观测。

---

## 3. 功能需求

### 3.1 协议治理与版本策略

#### FR-1：统一协议版本策略

**需求**：定义并落地 API 与 MCP 的版本策略、兼容性级别、弃用周期和升级指引。

**验收标准**：
- [x] 形成 `docs/protocol/VERSIONING.md`，覆盖 SemVer 与 breaking change 定义。
- [x] MCP 初始化协商与 API 版本选择规则一致化（可映射到同一 release policy）。
- [x] 提供至少 1 个“非破坏升级”与 1 个“破坏升级”流程示例。

#### FR-2：统一错误语义

**需求**：API 与 MCP 均采用统一错误域模型（错误码、可重试性、排查字段）。

**验收标准**：
- [x] API 错误使用 Problem Details（RFC 9457）模型。
- [x] MCP 错误码映射表与 API 错误域一一对应。
- [x] 客户端可通过 machine-readable 字段判断 `retryable` 与 `category`。

### 3.2 协议面最小可用能力

#### FR-3：API 最小能力面

**需求**：提供可稳定消费的最小 API 能力集（建议：`trigger`、`status`、`ledger/query`）。

**验收标准**：
- [x] 每个端点具备请求/响应 schema 与错误示例。
- [x] 至少 3 个端点完成契约测试。
- [x] 每个端点可追踪到治理层（budget/rate-limit/ledger）。

#### FR-4：MCP 最小能力面

**需求**：将 MCP 面收敛到可运营能力集（工具发现、工具调用、资源读取、基础状态查询）。

**验收标准**：
- [x] `initialize/tools/resources` 路径具备协议回归测试。
- [x] MCP 与 API 使用统一审计链路（同一 request correlation 维度可追踪）。
- [x] 明确 non-goal（如 prompts/sampling）并在文档中说明。

### 3.3 非 Python Golden Path

#### FR-5：Java 接入模板

**需求**：提供 Java 生态最小接入模板（HTTP 客户端 + MCP 客户端任选其一，建议 HTTP 先行）。

**验收标准**：
- [x] 提供可复制的 Java 调用示例（触发 + 查询 + 错误处理）。
- [x] 提供本地可执行脚本验证样例结果。
- [x] 文档包含鉴权、重试、超时与幂等建议。

### 3.4 协议演进安全网

#### FR-6：契约门禁与差异审计

**需求**：CI 引入协议差异检测与契约回归，阻断不兼容发布。

**验收标准**：
- [x] OpenAPI breaking check 进入 CI 阻断路径。
- [x] MCP 契约测试进入 CI 必跑路径。
- [x] 发布前输出协议变更报告（新增/兼容变更/破坏变更）。

---

## 4. 非功能需求

### 4.1 稳定性

**NFR-1：协议层可用性**
- API/MCP 协议层具备健康检查、限流、超时和降级策略。

**验收标准**：
- [x] 协议入口有健康检查与关键依赖探针。
- [x] 工具调用超时策略具备默认值并可配置。

### 4.2 性能

**NFR-2：协议调用时延**
- 在标准环境下，核心 API P95 小于既定阈值（由实现阶段定义并量化）。

**验收标准**：
- [x] 提供基线测试方法与报告模板。
- [x] 发布前输出至少一轮性能快照。

### 4.3 安全

**NFR-3：默认安全**
- 协议层默认拒绝高风险访问模式（未授权、私网 SSRF、异常来源等）。

**验收标准**：
- [x] 协议鉴权策略与失败审计路径明确。
- [x] 安全配置项可通过环境变量与配置文件管理。

---

## 5. 验收标准总览

### 5.1 功能验收

- [x] **FR-1**：版本策略、兼容规则、弃用流程文档化并可执行。
- [x] **FR-2**：API/MCP 错误语义统一且可机器消费。
- [x] **FR-3**：最小 API 面（3 端点）可用并通过契约测试。
- [x] **FR-4**：最小 MCP 面可用并通过协议回归。
- [x] **FR-5**：Java Golden Path 可执行。
- [x] **FR-6**：CI 契约门禁生效。

### 5.2 非功能验收

- [x] **NFR-1**：可用性探针与超时策略就绪。
- [x] **NFR-2**：性能基线可复现且有记录。
- [x] **NFR-3**：安全基线默认启用。

### 5.3 测试验收

- [x] 契约测试覆盖核心协议路径。
- [x] 回归测试覆盖错误语义与版本协商。
- [x] 协议变更报告自动生成。

---

## 6. 约束与假设

### 6.1 约束

- 协议优先阶段不得引入破坏现有生产路径的“大爆炸迁移”。
- 需兼容既有 `triggers-api`、`mcp-server`、`governance` 能力边界。
- 需保持 Hatchet/LLM/Langfuse 集成隔离约束不被破坏。

### 6.2 假设

- 主维护团队可提供至少一条 Java 集成验证环境。
- 当前 release 阻塞（PyPI token）后续可由维护者解除，不影响协议 spec 设计推进。

---

## 7. 依赖

### 7.1 外部依赖

- MCP 规范（versioning/lifecycle/security）
- API 版本治理实践（AIP/Problem Details）
- Java 客户端生态（HTTP 或 MCP）

### 7.2 内部依赖

- `mcp-server` spec（已完成）
- `triggers-api` spec（已完成）
- `governance`、`release`、`test-infra`（进行中）

---

## 8. 风险与缓解

### 8.1 风险：协议治理复杂度上升

**影响**：发布流程变慢，团队短期感知为“效率下降”。

**缓解**：

- 先做最小能力面，不追求一轮覆盖全部协议。
- 通过自动化门禁替代人工反复校对，降低长期维护成本。

### 8.2 风险：API/MCP 双栈重复建设

**影响**：维护成本和缺陷概率上升。

**缓解**：

- 统一网关与统一错误域，减少双实现分叉。
- 建立单一规范文档与差异报告机制。

### 8.3 风险：跨语言示例“写了但没人用”

**影响**：产出形同文档堆积。

**缓解**：

- Java 场景验收采用可执行脚本与调用证据，不仅是文档。

---

## 9. Definition of Done（DoD）

### 9.1 协议宪法

- [x] 版本策略、错误语义、兼容规则三份核心文档齐全且通过评审。
- [x] API/MCP 对齐矩阵可直接用于审查与回归。

### 9.2 最小协议面

- [x] API 3 个核心端点完成契约与回归测试。
- [x] MCP 核心路径完成契约与回归测试。

### 9.3 跨语言可用性

- [x] Java Golden Path 可执行并有证据。
- [x] curl 样例可独立复现核心调用链。

### 9.4 发布与安全网

- [x] CI 契约门禁对 breaking change 生效。
- [x] 协议变更报告可追溯。

### 9.5 红军评估

- [x] 至少完成一次“破坏性变更演练”并验证门禁可阻断。
- [x] 至少完成一次“协议降级/回滚演练”并验证运维手册有效。

---

## 10. 参考文档

- `docs/ARCHITECTURE_ANALYSIS.md`（决策 4.11 Protocol-first）
- `.kiro/specs/mcp-server/`
- `.kiro/specs/triggers-api/`
- `.kiro/specs/release/`
- `.kiro/specs/test-infra/`

---

**维护者**：OwlClaw 架构组  
**最后更新**：2026-02-27
